
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface PromptAnalysis {
  business_types: string[];
  services: string[];
  location: string;
  department?: string;
  output_format: string;
  strategy: string;
  keywords: string[];
  max_results?: number;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    console.log('üöÄ AI Prompt Scraping function called');
    
    // V√©rifier la requ√™te
    let requestBody;
    try {
      requestBody = await req.json();
    } catch (error) {
      console.error('‚ùå Erreur parsing JSON:', error);
      return new Response(
        JSON.stringify({ 
          error: 'Format de requ√™te invalide',
          details: 'Le body de la requ√™te doit √™tre du JSON valide'
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
          status: 400 
        }
      );
    }

    const { action, prompt, ai_model, output_format, analysis } = requestBody;

    console.log(`üìù D√©tails de la requ√™te:`, { 
      action, 
      ai_model, 
      promptLength: prompt?.length || 0,
      output_format 
    });

    // Validation des param√®tres
    if (!action || !['analyze', 'execute'].includes(action)) {
      console.error('‚ùå Action invalide:', action);
      return new Response(
        JSON.stringify({ 
          error: 'Action invalide',
          details: 'L\'action doit √™tre "analyze" ou "execute"'
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
          status: 400 
        }
      );
    }

    if (action === 'analyze') {
      if (!prompt || !prompt.trim()) {
        console.error('‚ùå Prompt manquant pour l\'analyse');
        return new Response(
          JSON.stringify({ 
            error: 'Prompt requis',
            details: 'Un prompt est n√©cessaire pour l\'analyse'
          }),
          { 
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
            status: 400 
          }
        );
      }

      return await analyzePrompt(prompt, ai_model || 'deepseek', output_format || 'tableau');
    } 
    
    if (action === 'execute') {
      if (!analysis) {
        console.error('‚ùå Analyse manquante pour l\'ex√©cution');
        return new Response(
          JSON.stringify({ 
            error: 'Analyse requise',
            details: 'Une analyse est n√©cessaire avant l\'ex√©cution'
          }),
          { 
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
            status: 400 
          }
        );
      }

      return await executeScraping(prompt, ai_model || 'deepseek', output_format || 'tableau', analysis);
    }

  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale dans AI Prompt Scraping:', error);
    return new Response(
      JSON.stringify({ 
        error: 'Erreur interne du serveur',
        details: error.message || 'Une erreur inattendue s\'est produite',
        timestamp: new Date().toISOString()
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
        status: 500 
      }
    );
  }
});

async function analyzePrompt(prompt: string, aiModel: string, outputFormat: string) {
  console.log('üß† D√©but analyse du prompt avec', aiModel);

  try {
    // Pour le moment, on fait une analyse simul√©e pour √©viter les erreurs d'API
    console.log('üìù Analyse simul√©e du prompt (longueur:', prompt.length, 'caract√®res)');
    
    // Analyse basique du prompt pour extraire des informations
    const lowerPrompt = prompt.toLowerCase();
    
    // D√©tection des types d'entreprises
    const businessTypes = [];
    if (lowerPrompt.includes('r√©parateur') || lowerPrompt.includes('reparateur')) businessTypes.push('r√©parateur');
    if (lowerPrompt.includes('smartphone') || lowerPrompt.includes('t√©l√©phone')) businessTypes.push('r√©parateur t√©l√©phone');
    if (lowerPrompt.includes('ordinateur') || lowerPrompt.includes('informatique')) businessTypes.push('r√©parateur informatique');
    if (lowerPrompt.includes('boutique') || lowerPrompt.includes('magasin')) businessTypes.push('boutique');
    if (businessTypes.length === 0) businessTypes.push('r√©parateur g√©n√©ral');

    // D√©tection des services
    const services = [];
    if (lowerPrompt.includes('r√©paration')) services.push('r√©paration');
    if (lowerPrompt.includes('vente') || lowerPrompt.includes('vendent')) services.push('vente');
    if (lowerPrompt.includes('soudure')) services.push('micro-soudure');
    if (lowerPrompt.includes('√©cran')) services.push('r√©paration √©cran');
    if (services.length === 0) services.push('r√©paration g√©n√©rale');

    // D√©tection de la localisation
    let location = 'France';
    let department = null;
    const deptMatch = prompt.match(/d√©partement\s+(\d{2,3})/i) || prompt.match(/\b(\d{2})\b/);
    if (deptMatch) {
      department = deptMatch[1].padStart(2, '0');
      location = `D√©partement ${department}`;
    }

    // D√©tection du format
    let detectedFormat = outputFormat;
    if (lowerPrompt.includes('tableau')) detectedFormat = 'tableau';
    if (lowerPrompt.includes('csv')) detectedFormat = 'csv';
    if (lowerPrompt.includes('liste')) detectedFormat = 'liste';

    // G√©n√©ration des mots-cl√©s
    const keywords = [...businessTypes, ...services];
    if (department) keywords.push(`d√©partement ${department}`);

    const analysisResult: PromptAnalysis = {
      business_types: businessTypes,
      services: services,
      location: location,
      department: department,
      output_format: detectedFormat,
      strategy: `Recherche de ${businessTypes.join(', ')} dans ${location} avec focus sur ${services.join(', ')}`,
      keywords: keywords,
      max_results: 50
    };

    console.log('‚úÖ Analyse termin√©e:', analysisResult);

    return new Response(
      JSON.stringify({ 
        success: true, 
        analysis: analysisResult,
        original_prompt: prompt,
        method: 'analysis_simul√©e'
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('‚ùå Erreur lors de l\'analyse:', error);
    
    return new Response(
      JSON.stringify({ 
        error: 'Erreur d\'analyse',
        details: error.message || 'Impossible d\'analyser le prompt',
        timestamp: new Date().toISOString()
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
        status: 500 
      }
    );
  }
}

async function executeScraping(prompt: string, aiModel: string, outputFormat: string, analysis: PromptAnalysis) {
  console.log('üöÄ Ex√©cution du scraping simul√©');

  try {
    // G√©n√©ration de donn√©es de test bas√©es sur l'analyse
    const mockResults = generateEnhancedMockResults(analysis);
    const formattedResults = formatResults(mockResults, analysis.output_format);

    console.log(`‚úÖ Scraping simul√© termin√©: ${formattedResults.length} r√©sultats g√©n√©r√©s`);

    return new Response(
      JSON.stringify({ 
        success: true, 
        results: formattedResults,
        analysis: analysis,
        total_count: formattedResults.length,
        method: 'scraping_simul√©',
        note: "R√©sultats simul√©s - int√©gration du vrai scraping en cours"
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('‚ùå Erreur lors du scraping:', error);
    
    return new Response(
      JSON.stringify({ 
        error: 'Erreur de scraping',
        details: error.message || 'Impossible d\'ex√©cuter le scraping',
        timestamp: new Date().toISOString()
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }, 
        status: 500 
      }
    );
  }
}

function generateEnhancedMockResults(analysis: PromptAnalysis): any[] {
  const mockData = [];
  const businessTypes = analysis.business_types || ['r√©parateur'];
  const location = analysis.location || 'France';
  const department = analysis.department || '01';

  // R√©parateurs sp√©cialis√©s avec micro-soudure
  const specializedRepairers = [
    {
      nom: "Docteur IT / Acta Micro",
      adresse: "123 Avenue de la R√©paration",
      city: "Bourg-en-Bresse",
      services: "R√©paration smartphones, tablettes, ordinateurs",
      specialites: "Micro-soudure, r√©paration high-tech",
      telephone: "04 74 XX XX XX",
      website: "www.docteur-it.fr",
      email: "contact@docteur-it.fr",
      department: department,
      verified: true,
      category: "specialise"
    },
    {
      nom: "CHRONOPHONE",
      adresse: "45 Rue du Commerce",
      city: "Bourg-en-Bresse",
      services: "R√©paration smartphones et tablettes",
      specialites: "Magasin sp√©cialis√©",
      telephone: "04 74 XX XX XX",
      website: "chronophone01.fr",
      email: "info@chronophone01.fr",
      department: department,
      verified: true,
      category: "specialise"
    },
    {
      nom: "Bresse Media Phone",
      adresse: "67 Boulevard Principal",
      city: "Bourg-en-Bresse",
      services: "R√©paration t√©l√©phones portables",
      specialites: "+20 ans d'exp√©rience",
      telephone: "04 74 XX XX XX",
      website: null,
      email: "contact@bresse-media-phone.fr",
      department: department,
      verified: true,
      category: "specialise"
    },
    {
      nom: "Ain Point Phone",
      adresse: "89 Place du March√©",
      city: "Bourg-en-Bresse",
      services: "R√©paration iPhone, iPad, iPod, smartphones",
      specialites: "Pi√®ces d√©tach√©es et accessoires",
      telephone: "04 74 XX XX XX",
      website: "ain-point-phone.fr",
      email: "service@ain-point-phone.fr",
      department: department,
      verified: true,
      category: "specialise"
    },
    {
      nom: "Cash and Repair",
      adresse: "12 Rue de la Technologie",
      city: "Bourg-en-Bresse",
      services: "R√©paration smartphones et tablettes",
      specialites: "Micro-soudure disponible",
      telephone: "04 74 XX XX XX",
      website: "ateliers.cashandrepair.fr",
      email: "bourg@cashandrepair.fr",
      department: department,
      verified: true,
      category: "specialise"
    }
  ];

  // Grandes enseignes avec corners
  const chainStores = [
    {
      nom: "Save (Corner Fnac)",
      adresse: "Magasin Fnac, Centre Commercial",
      city: "Viriat",
      services: "R√©paration smartphones et tablettes",
      specialites: "R√©paration en 40 min (80% des cas), garantie 1 an",
      telephone: "04 74 XX XX XX",
      website: "magasin.save.co",
      email: "viriat@save.co",
      department: department,
      verified: true,
      category: "enseigne"
    },
    {
      nom: "Mister Minit",
      adresse: "Centre Commercial Carrefour",
      city: "Bourg-en-Bresse",
      services: "R√©paration smartphones",
      specialites: "Remplacement √©crans, batteries, protections",
      telephone: "04 74 XX XX XX",
      website: "misterminit.eu",
      email: "bourg@misterminit.eu",
      department: department,
      verified: true,
      category: "enseigne"
    },
    {
      nom: "WeFix",
      adresse: "Plusieurs emplacements",
      city: `D√©partement ${department}`,
      services: "R√©paration smartphones et tablettes",
      specialites: "R√©seau national sp√©cialis√©",
      telephone: "Service client national",
      website: "boutique.wefix.net",
      email: "contact@wefix.net",
      department: department,
      verified: true,
      category: "enseigne"
    }
  ];

  // Boutiques op√©rateurs
  const operatorStores = [
    {
      nom: "Orange",
      adresse: "1 Rue Montaigne",
      city: "Oyonnax (01100)",
      services: "Vente smartphones, tablettes, montres connect√©es",
      specialites: "Boutique officielle",
      telephone: "T√©l. disponible sur place",
      website: "orange.fr",
      email: "oyonnax@orange.fr",
      department: department,
      verified: true,
      category: "operateur"
    },
    {
      nom: "SFR",
      adresse: "93 rue Anatole France",
      city: "Oyonnax (01100)",
      services: "Vente smartphones, tablettes, montres connect√©es",
      specialites: "Boutique officielle",
      telephone: "04 74 XX XX XX",
      website: "sfr.fr",
      email: "oyonnax@sfr.fr",
      department: department,
      verified: true,
      category: "operateur"
    },
    {
      nom: "Free",
      adresse: "22 rue Gambetta",
      city: "Bourg-en-Bresse (01000)",
      services: "Vente smartphones, tablettes",
      specialites: "Free Center",
      telephone: "10 44",
      website: "free.fr",
      email: "bourg@free.fr",
      department: department,
      verified: true,
      category: "operateur"
    },
    {
      nom: "Orange",
      adresse: "Centre commercial",
      city: "Bourg-en-Bresse",
      services: "Vente smartphones, tablettes, montres connect√©es",
      specialites: "Boutique/Corner",
      telephone: "04 74 XX XX XX",
      website: "orange.fr",
      email: "bourg@orange.fr",
      department: department,
      verified: true,
      category: "operateur"
    }
  ];

  // Combinaison de toutes les cat√©gories
  mockData.push(...specializedRepairers, ...chainStores, ...operatorStores);

  return mockData.slice(0, analysis.max_results || 20);
}

function formatResults(results: any[], format: string): any[] {
  switch (format) {
    case 'tableau':
      return results;
    case 'liste':
      return results.map(r => ({ 
        nom: r.nom, 
        adresse: r.adresse, 
        telephone: r.telephone 
      }));
    case 'json':
      return results;
    case 'csv':
      return results; // Le frontend se chargera de la conversion CSV
    default:
      return results;
  }
}
